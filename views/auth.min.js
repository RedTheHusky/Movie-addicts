let authAlert;let auth2Pages={init:function(){this.initDone=!0;this.addEvent();this.display()},addEvent:function(){if(document.querySelector("#btnUserAuth")){let me=this;document.querySelector("#btnUserAuth").addEventListener("click",function(event){event.preventDefault();if(Auth.getAccessToken()){Auth.userLogOut().then(function(resolve){if(typeof doAfterSuccessLogOut!=="undefined"){try{authAlert.addAlert2Root();authAlert.setType('success');me.display();authAlert.setElement([{selector:".alert-body",task:"inner",value:"Successfully loged out."},"show"]);authAlert.slideup();doAfterSuccessLogOut({response:resolve})}
catch(err){console.warn('error at function call:',err)}}else{location.reload()}},function(reject){console.warn('AuthRegister.userLogOut response:reject=',reject);if(typeof doAfterFailedLogOut!=="undefined"){try{authAlert.addAlert2Root();authAlert.setType('danger');authAlert.setElement([{selector:".alert-body",task:"inner",value:"Failed to log out."},"show"]);authAlert.slideup();doAfterFailedLogOut({response:reject})}
catch(err){console.warn('error at function call:',err)}}else{}})}else{authModal.show()}})}else{console.warn("button not found, can't add event")}},display:function(){if(Auth.getAccessToken()){if(document.querySelector("#labelUserName")){document.querySelector("#labelUserName").innerText="You are logged in as "+Auth.getAccessName()}
if(document.querySelector("#btnUserAuth")){document.querySelector("#btnUserAuth").innerText="Log out"}}else{if(document.querySelector("#labelUserName")){document.querySelector("#labelUserName").innerText="No user is loged in"}
if(document.querySelector("#btnUserAuth")){document.querySelector("#btnUserAuth").innerText="Log in"}}}}
let authModal={init:function(options={root:"body",addModal2Root:!0,add2Head:!0,addEvents:!0}){this.initDone=!0;if(!(typeof options==='object')){options={}};function uuidv4(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}
this.root={id:'',dom:'',jquery:''};this.modal="";this.widgetId=-1;this.id=uuidv4();this.profile={mode:1,eye:0,protocol:'',mouseEye:0};this.statusLog={inputError:[]};this.settings={nameLength_min:6,nameLength_max:36,passwordLength_min:6,passwordLength_max:36,classList:{invalid:"error-content"}};if(options.root){this.root.id=options.root;if(this.root.id){this.root.dom=document.getElementById(this.root.id);this.root.jquery=$('#'+this.root.id)}
if(options.addModal2Root){this.addModal2Root(options.addModal2Root);if(options.addEvents){this.addEvents()}}}
if(options.add2Head){this.add2Head(options.add2Head)}
this.profile.protocol=location.protocol},add2Head:function(options={}){if(!(typeof options==='object')){options={}};let script={};script.recaptcha=document.createElement("script");let me=this;script.recaptcha.src="https://www.google.com/recaptcha/api.js?onload=recaptchaLoaded&render=explicit";document.head.appendChild(script.recaptcha);if(script.recaptcha.addEventListener){script.recaptcha.addEventListener('load',function(){},!1)}},addModal2Root:function(options={}){if(!(typeof options==='object')){options={}};if(options.root){this.root.id=options.root;if(this.root.id){this.root.dom=document.getElementById(this.root.id);this.root.jquery=$('#'+this.root.id)}}
this.modal=new Modal({root:this.root.id});let content=`<div class="modal-dialog"><form name=formAuth" action="">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">User Log In</h4>
      </div>
      <div class="modal-body">
			<div class='loginOrRegister'>
				<div class='form-group'>
					<input type="text" name="username" placeholder='Username' value="" autocomplete="username" class="username text-input form-control inputKeyupCheck">
				</div>
				<div class='form-group register-group' style="display:none">
					<input type="text" name="email" placeholder='Email' value="" autocomplete="email" class="email text-input form-control register-input inputKeyupCheck">
				</div>
				<div class='form-group' style="display:block">
					<input type="password" name="password" value="" autocomplete="password" placeholder='Password' class="password text-input form-control inputKeyupCheck" style="display:inline; width:90%"><button type="button" class="btn btn-warning btn-eye2Password" style="display:inline;"><img id="passwordEye" src="../static/password_eyes.png" alt="password_eyes" height="20" width="20"></button>
				</div>
				<div class='form-group register-group' style="display:none">
					<input type="password" name="inputConfirmPassword" autocomplete="new-password" value="" placeholder='Retype your Password' class="confirm-password text-input form-control register-input inputKeyupCheck" >
				</div>
				<div class='form-group register-group' id="add_g-recaptcha_here_${this.id}" style="display:none">
					
				</div>
			</div>
			<div class='notification' style="display:none">

			</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger bt-close" data-dismiss="modal">Close</button>
		<button type="button" class="btn btn-primary bt-loginOrRegister">Log In</button>
		<button type="button" class="btn btn-secondary bt-newuserOrback">New</button>
		<button type="button" class="btn btn-secondary bt-closenotification" style="display:none">Retry</button>
      </div>
    </div>

  </form></div>`;this.modal.content=content;if(!options.addSkip){this.modal.addModal2Root(options.modal)}},displayLogIn:function(){this.inputClear();this.profile.mode=1;this.modal.modal.dom.querySelectorAll('.register-group').forEach(function(element,index){element.style.display="none"});this.modal.modal.dom.querySelectorAll('.register-input').forEach(function(element,index){element.value=""});this.modal.modal.dom.querySelector('.modal-title').innerHTML="User Log In";this.modal.modal.dom.querySelector('.bt-newuserOrback').innerHTML="New";this.modal.modal.dom.querySelector('.bt-loginOrRegister').innerHTML="Log In";this.modal.modal.dom.querySelector('.username').focus()},displayRegister:function(){this.inputClear();this.profile.mode=2;if(this.profile.protocol!=="file:"){if(this.widgetId===-1){let me=this;this.widgetId=grecaptcha.render('add_g-recaptcha_here_'+me.id,{'sitekey':'6LefgYEUAAAAAN1Loro_VTlFvcOcDvYfscJ1dlMH','callback':'recaptchaSuccess','expired-callback':'recaptchaExpired','error-callback':'recaptchaError'})}else{}}else{console.warn('Its not on network, disabling g-recaptcha requirement')}
this.modal.modal.dom.querySelectorAll('.register-group').forEach(function(element,index){element.style.display="block"});this.modal.modal.dom.querySelector('.modal-title').innerHTML="New User Register";this.modal.modal.dom.querySelector('.bt-newuserOrback').innerHTML="Back";this.modal.modal.dom.querySelector('.bt-loginOrRegister').innerHTML="Register";this.modal.modal.dom.querySelector('.username').focus()},addEvents:function(){let me=this;this.modal.modal.dom.querySelector('.bt-close').addEventListener("click",function(event){event.preventDefault();me.inputClear();me.eye2PasswordToggle(-1);me.displayNotificationUndo()});this.modal.modal.dom.querySelector('.bt-closenotification').addEventListener("click",function(event){event.preventDefault();me.displayNotificationUndo()});this.modal.modal.dom.querySelector(".btn-eye2Password").addEventListener("click",function(event){event.preventDefault();me.eye2PasswordToggle(2)});this.modal.modal.dom.querySelector(".bt-newuserOrback").addEventListener("click",function(event){event.preventDefault();if(me.profile.mode===1){me.displayRegister()}else{me.displayLogIn()}});this.modal.modal.dom.querySelector(".bt-loginOrRegister").addEventListener("click",function(event){event.preventDefault();if(me.profile.mode===1){me.callLogIn()}else{me.callRegister()}});function inputKeyupEvent(element){element.addEventListener("keyup",function(event){if(element.name.toLowerCase().includes("password")){me.inputKeyupCheck({element:element,type:'password'})}else if(element.name.toLowerCase().includes("name")){me.inputKeyupCheck({element:element,type:'name'})}else if(element.name.toLowerCase().includes("email")){me.inputKeyupCheck({element:element,type:'email'})}})}
this.modal.modal.dom.querySelectorAll('.inputKeyupCheck').forEach(function(element,index){inputKeyupEvent(element)});this.modal.modal.dom.querySelector(".btn-eye2Password").addEventListener("mouseover",function(event){event.preventDefault();me.profile.mouseEye=!0;me.eye2PasswordToggle(1)});this.modal.modal.dom.querySelector(".btn-eye2Password").addEventListener("mouseleave",function(event){event.preventDefault();me.profile.mouseEye=!1;me.eye2PasswordToggle(0)});this.modal.modal.dom.querySelector(".username").addEventListener("keyup",function(event){if(event.keyCode===13&&me.inputKeyupCheck({element:this,type:"name"})){if(me.profile.mode===2){me.modal.modal.dom.querySelector(".email").focus()}else{me.modal.modal.dom.querySelector(".password").focus()}}});this.modal.modal.dom.querySelector(".password").addEventListener("keyup",function(event){if(event.keyCode===13&&me.inputKeyupCheck({element:this,type:"password"})){if(me.profile.mode===2){me.modal.modal.dom.querySelector(".confirm-password").focus()}else{me.modal.modal.dom.querySelector(".bt-loginOrRegister").focus()}}});this.modal.modal.dom.querySelector(".email").addEventListener("keyup",function(event){if(event.keyCode===13&&me.inputKeyupCheck({element:this,type:"password"})){me.modal.modal.dom.querySelector(".password").focus()}});this.modal.modal.dom.querySelector(".confirm-password").addEventListener("keyup",function(event){if(event.keyCode===13&&me.inputKeyupCheck({element:this,type:"password"})){}})},eye2PasswordToggle:function(mode=0){if(mode===-1){this.profile.eye=!1}
if(mode===2||mode===20||mode===21){if(mode===20){this.profile.eye=!0}
if(mode===21){this.profile.eye=!1}
if(this.profile.eye){this.profile.eye=!1;this.modal.modal.dom.querySelector('input[name="password"]').setAttribute('type','password');this.modal.modal.dom.querySelector(".btn-eye2Password").classList.add("btn-warning");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-info");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-success")}else{this.profile.eye=!0;this.modal.modal.dom.querySelector('input[name="password"]').setAttribute('type','text');this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-warning");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-info");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.add("btn-success")}}else if(mode===1){if(!this.profile.eye){this.modal.modal.dom.querySelector('input[name="password"]').setAttribute('type','text');this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-warning");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.add("btn-info")}}else{if(!this.profile.eye){this.modal.modal.dom.querySelector('input[name="password"]').setAttribute('type','password');this.modal.modal.dom.querySelector(".btn-eye2Password").classList.add("btn-warning");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-info");this.modal.modal.dom.querySelector(".btn-eye2Password").classList.remove("btn-success")}}},inputClear:function(){let me=this;this.modal.modal.dom.querySelectorAll('.text-input').forEach(function(element,index){element.value="";element.classList.remove(me.settings.classList.invalid)})},inputKeyupCheckClear:function(){let me=this;this.modal.modal.dom.querySelectorAll('.inputKeyupCheck').forEach(function(element,index){element.classList.remove(me.settings.classList.invalid)})},inputKeyupCheck:function(options={}){let result=!0;if(!options.element){console.warn('invali');return!1}
let text=options.element.value.trim();if(options.type){if(options.type==='name'){if(text.length<this.settings.nameLength_min){options.element.classList.add(this.settings.classList.invalid);result=!1}else if(text.length>this.settings.nameLength_max){options.element.classList.add(this.settings.classList.invalid);result=!1}else{options.element.classList.remove(this.settings.classList.invalid)}}else if(options.type==='password'){if(text.length<this.settings.passwordLength_min){options.element.classList.add(this.settings.classList.invalid);result=!1}else if(text.length>this.settings.passwordLength_max){options.element.classList.add(this.settings.classList.invalid);result=!1}else{options.element.classList.remove(this.settings.classList.invalid)}}else if(options.type==='email'){if(!this.validateEmail(text)){options.element.classList.add(this.settings.classList.invalid);result=!1}else{options.element.classList.remove(this.settings.classList.invalid);result=!1}}}
return result},validateEmail:function(email){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;var result=re.test(String(email).toLowerCase());return result},inputCheck:function(){var errorLog=[];this.modal.modal.dom.querySelectorAll('input').forEach(function(input,i){input.value=input.value.trim()});if(this.modal.modal.dom.querySelector('input[name="username"]').value.length<this.settings.nameLength_min){console.warn('name too small');errorLog.push('name too small')}
if(this.modal.modal.dom.querySelector('input[name="username"]').value.length>this.settings.nameLength_max){console.warn('name too big');errorLog.push('name too big')}
if(this.modal.modal.dom.querySelector('input[name="password"]').value.length<this.settings.passwordLength_min){console.warn('password too small');errorLog.push('password too small')}
if(this.modal.modal.dom.querySelector('input[name="password"]').value.length>this.settings.passwordLength_max){console.warn('password too big');errorLog.push('password too big')}
if(this.profile.mode===2){if(this.modal.modal.dom.querySelector('input[name="inputConfirmPassword"]').value!=this.modal.modal.dom.querySelector('input[name="password"]').value){console.warn('password not a match');errorLog.push('password not a match')}
if(!this.validateEmail(this.modal.modal.dom.querySelector('input[name="email"]').value)){console.warn('email is not valid');errorLog.push('email is not valid')}
if(this.profile.protocol!=="file:"){if(!grecaptcha.getResponse()){console.warn('reCaptcha not verified');errorLog.push('reCaptcha not verified')}}else{console.warn('Its not on network, disabling g-recaptcha requirement')}}
this.statusLog.inputError=errorLog;if(errorLog.length>0){console.warn('has error, will not commence ajax');console.warn('errorLog=',errorLog);let errorMessage="";errorLog.forEach(function(e,i){errorMessage+=`<p>${e}</p>`});if(this.profile.mode===1){this.displayNotification({type:-1,title:"A problem at User Log In",body:"<p>The following problems have occurred:</p>"+errorMessage})}else if(this.profile.mode===2){this.displayNotification({type:-1,title:"A problem at New User Registering",body:"<p>The following problems have occurred:</p>"+errorMessage})}
console.warn('return:false');return!1}
return!0},displayNotificationUndo:function(){this.modal.modal.dom.querySelector('.loginOrRegister').style.display="";this.modal.modal.dom.querySelector('.notification').style.display="none";this.modal.modal.dom.querySelector('.bt-loginOrRegister').style.display="";this.modal.modal.dom.querySelector('.bt-newuserOrback').style.display="";this.modal.modal.dom.querySelector('.bt-closenotification').style.display="none"},displayNotification:function(options={}){if(options.type){if(options.type===1){this.modal.modal.dom.querySelector('.bt-closenotification').style.display="none"}else if(options.type===-1){this.modal.modal.dom.querySelector('.bt-closenotification').style.display=""}}
if(options.body){this.modal.modal.dom.querySelector('.notification').innerHTML=options.body}
this.modal.modal.dom.querySelector('.bt-loginOrRegister').style.display="none";this.modal.modal.dom.querySelector('.bt-newuserOrback').style.display="none";this.modal.modal.dom.querySelector('.loginOrRegister').style.display="none";this.modal.modal.dom.querySelector('.notification').style.display="block"},callLogIn:function(){if(this.inputCheck()){var data={};data.username=this.modal.modal.dom.querySelector('input[name="username"]').value.trim();data.password=this.modal.modal.dom.querySelector('input[name="password"]').value.trim();let me=this;this.statusLog.callResponse={status:0,mode:1,data:data,response:""};this.displayNotification({type:1,body:"<p>Please wait</p>"});Auth.userLogIn(data).then(function(resolve){me.statusLog.callResponse.status=1;me.statusLog.callResponse.response=resolve;me.close();if(typeof doAfterSuccessLogin!=="undefined"){try{authAlert.addAlert2Root();authAlert.setType('success');auth2Pages.display();authAlert.setElement([{selector:".alert-body",task:"inner",value:"Successfully loged in."},"show"]);authAlert.slideup();doAfterSuccessRegister({obj:me,response:resolve})}
catch(err){console.warn('error at function call:',err)}}else{me.doAfterSuccessResponse()}},function(reject){me.statusLog.callResponse.status=-1;me.statusLog.callResponse.response=reject;if(typeof doAfterFailedLogin!=="undefined"){me.close();try{doAfterFailedLogin({obj:me,response:reject})}
catch(err){console.warn('error at function call:',err)}}else{reject.called="Log in";me.doAfterRejectedResponse(reject)}})}else{console.warn('aborded')}},callRegister:function(){if(this.inputCheck()){var data={};data.username=this.modal.modal.dom.querySelector('input[name="username"]').value.trim();data.password=this.modal.modal.dom.querySelector('input[name="password"]').value.trim();this.displayNotification({type:1,body:"<p>Please wait</p>"});let me=this;this.statusLog.callResponse={status:0,mode:2,data:data,response:""};Auth.userRegister(data).then(function(resolve){me.statusLog.callResponse.status=1;me.statusLog.callResponse.response=resolve;me.close();if(typeof doAfterSuccessRegister!=="undefined"){try{authAlert.addAlert2Root();authAlert.setType('success');auth2Pages.display();authAlert.setElement([{selector:".alert-body",task:"inner",value:"Successfully registered."},"show"]);authAlert.slideup();doAfterSuccessRegister({obj:me,response:resolve})}
catch(err){console.warn('error at function call:',err)}}else{me.doAfterSuccessResponse()}},function(reject){reject.called="Register";me.statusLog.callResponse.status=-1;me.statusLog.callResponse.response=reject;if(typeof doAfterFailedRegister!=="undefined"){me.close();try{doAfterFailedRegister({obj:me,response:reject})}
catch(err){console.warn('error at function call:',err)}}else{me.doAfterRejectedResponse(reject)}})}else{console.warn('aborded')}},doAfterSuccessResponse:function(){location.reload()},doAfterRejectedResponse:function(response=""){if(response.status){console.warn('status:',response.status)}
let errorMessage;if(response.responseJSON&&response.responseJSON.message){errorMessage=response.responseJSON.message}else if(response.message){errorMessage=response.message}
if(this.profile.mode===1){this.displayNotification({type:-1,title:"A problem at User Log In",body:"<p>The following problems have occurred:</p>"+errorMessage})}else if(this.profile.mode===2){this.displayNotification({type:-1,title:"A problem at New User Registering",body:"<p>The following problems have occurred:</p>"+errorMessage})}},show:function(){this.modal.show();let me=this;setTimeout(function(){me.modal.modal.dom.querySelector('.username').focus()},500)},hide:function(){this.modal.hide()},open:function(){this.inputClear();this.eye2PasswordToggle(-1);this.displayNotificationUndo();this.modal.show()},close:function(){this.modal.hide();this.inputClear();this.eye2PasswordToggle(-1);this.displayNotificationUndo()}}