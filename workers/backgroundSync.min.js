let timerForCheckingModificationl={mcycle:60000,obj:'',mfire:60000,mcount:0};let mode=0;let movies={main:{items:[],pagination:{}},background:{items:[],pagination:{}},settings:{skip:0,take:10,searchParam:'',category:''}};let movie={main:{},background:{},id:''};let movieUrl='https://ancient-caverns-16784.herokuapp.com/movies'
let urlMovies='';let stats={received:0,sent:0,called:{mode:0,movies:{reset:0,items:0,pagination:0,skip:0,searchparam:0,category:0},movie:{details:0,id:0},timer:{start:0,stop:0,mcycle:0,mfire:0}},xhttp:{calls:0,success:0,failure:0},checkup:{up2Date:0,modified:0}};self.onmessage=function(msg){stats.received++;if(msg.data.mode){stats.called.mode++;mode=msg.data.mode;buildUrlMovies()}
if(msg.data.movies){if(msg.data.movies.reset){stats.called.movies.reset++;movies={main:{items:[],pagination:{}},background:{items:[],pagination:{}},settings:{skip:0,take:10,searchParam:'',category:''}}}
if(msg.data.movies.items){stats.called.movies.items++;movies.main.items=msg.data.movies.items;console.log("items=",movies.main.items)}
if(msg.data.movies.pagination){stats.called.movies.pagination++;movies.main.pagination=msg.data.movies.pagination;console.log("pagination=",movies.main.pagination)}
if(msg.data.movies.skip){stats.called.movies.skip++;movies.settings.skip=msg.data.movies.skip;buildUrlMovies()}
if(msg.data.movies.searchparam){stats.called.movies.searchparam++;movies.settings.searchParam=msg.data.movies.searchparam;buildUrlMovies()}
if(msg.data.movies.category){stats.called.movies.category++;movies.settings.category=msg.data.movies.category;buildUrlMovies()}}
if(msg.data.movie){if(msg.data.movie.details){stats.called.movie.details++
movie.main=msg.data.movie.details;buildUrlMovies()}
if(msg.data.movie.id){stats.called.movie.id++
movie.id=msg.data.movie.id;buildUrlMovies()}}
if(msg.data.timer){if(msg.data.timer.command==="start"){stats.called.timer.start++;startTimerInterval()}else if(msg.data.timer.command==="stop"){stats.called.timer.stop++;stopTimerInterval()}
if(msg.data.timer.mcycle){stats.called.timer.mcycle++;stats.called.timer4Check++;timerForCheckingModificationl.mcycle=msg.data.timer.mcycle}
if(msg.data.timer.mfire){stats.called.timer.mfire++;stats.called.timer4Check++;timerForCheckingModificationl.mfire=msg.data.timer.mfire}}
if(msg.data.get){if(msg.data.get==="stats"){let tmp={};function addMain(key){tmp[key]=stats[key]}
addMain("received");addMain("sent");addMain("called");addMain("xhttp");addMain("checkup");reply({stats:tmp,timer:timerForCheckingModificationl,movies:movies,movie:movie})}}}
function startTimerInterval(){if(timerForCheckingModificationl.obj){clearInterval(timerForCheckingModificationl.obj);timerForCheckingModificationl.obj=''}
if(mode!=1&&mode!=2){console.warn('No mode selected. Ignoring setIterval');return}
if(location.protocol==="file:"){console.warn('Protocol is invalid. Ignoring setIterval');return}
timerForCheckingModificationl.mcount=0;timerForCheckingModificationl.obj=setInterval(doAjaxCheckup,timerForCheckingModificationl.mcycle)}
function stopTimerInterval(){if(timerForCheckingModificationl.obj){clearInterval(timerForCheckingModificationl.obj);timerForCheckingModificationl.obj=''}}
function buildUrlMovies(){if(mode===1){if(!movies.settings.category||!movies.settings.searchParam){urlMovies=movieUrl+`?take=${movies.settings.take}&skip=${movies.settings.skip}`}else{urlMovies=movieUrl+`?${movies.settings.category}=${movies.settings.searchParam}&take=${movies.settings.take}&skip=${movies.settings.skip}`}}else if(mode===2){urlMovies=movieUrl+"/"+movie.id}}
function doAjaxCheckup(){console.log("checking4Modifications");timerForCheckingModificationl.mcount+=timerForCheckingModificationl.mcycle;if(timerForCheckingModificationl.mcount<timerForCheckingModificationl.mfire){return}
timerForCheckingModificationl.mcount=0;if(urlMovies===''){buildUrlMovies()}
var xhttp=new XMLHttpRequest();xhttp.onreadystatechange=function(){if(this.readyState==4&&this.status==200){stats.xhttp.success++;var obj=JSON.parse(xhttp.responseText);createCatche(obj);if(!checkifTheyAreTheSame()){if(mode===1){console.warn("They not the same, so need to send it back to main!");reply({update:{items:movies.background.items,pagination:movies.background.pagination}});reply({display:!0})}else if(mode===2){console.warn("They not the same, so need to send it back to detailsMovie!");reply({update:{details:movie.background}});reply({display:!0})}}}else if(this.readyState==4&&this.status!=200){console.warn("Unexpected result");stats.xhttp.failure++}};xhttp.open("GET",urlMovies,!0);stats.xhttp.calls++;xhttp.send()}
function createCatche(obj){if(mode===1){let results=obj.results;movies.background.pagination=obj.pagination;movies.background.items=[];results.forEach(function(one,index){let movie={};movie._id=one._id;movie.Title=one.Title;movie.Year=one.Year;movie.Runtime=one.Runtime;movie.Genre=one.Genre;movie.Director=one.Director;movie.Writer=one.Writer;movie.Actors=one.Actors;movie.Plot=one.Plot;movie.Language=one.Language;movie.Country=one.Country;movie.Poster=one.Poster;movie.imdbRating=one.imdbRating;movies.background.items.push(movie)})}
if(mode===2){movie.background._id=obj._id;movie.background.Title=obj.Title;movie.background.Year=obj.Year;movie.background.Runtime=obj.Runtime;movie.background.Genre=obj.Genre;movie.background.Director=obj.Director;movie.background.Writer=obj.Writer;movie.background.Actors=obj.Actors;movie.background.Plot=obj.Plot;movie.background.Language=obj.Language;movie.background.Country=obj.Country;movie.background.Poster=obj.Poster;movie.background.imdbRating=obj.imdbRating}}
function checkifTheyAreTheSame(){function isObjEquivalent(a,b){var aProps=Object.getOwnPropertyNames(a);var bProps=Object.getOwnPropertyNames(b);if(aProps.length!=bProps.length){console.warn("notEquivalent->invalud lenght");return!1}
for(var i=0;i<aProps.length;i++){var propName=aProps[i];if(a[propName]!=b[propName]){console.warn("notEquivalent->",[propName,a[propName],b[propName]]);return!1}}
return!0}
if(mode===1){if(movies.main.items.length!=movies.background.items.length){console.warn("array lenght invalid");stats.checkup.modified++;return!1}else{let ok=!0;let i=0;while(i<movies.main.items.length&&ok){if(isObjEquivalent(movies.main.items[i],movies.background.items[i])){}else{console.warn("notEquivalent:",[movies.main.items[i],movies.background.items[i]]);ok=!1}
i++}
if(ok){stats.checkup.up2Date++;return!0}else{stats.checkup.modified++;return!1}}}else if(mode===2){if(isObjEquivalent(movie.main,movie.background)){console.warn("notEquivalent:",[movie.main,movie.background]);return!0}else{return!1}}}
function reply(obj={none:'none'}){if(obj){stats.sent++;postMessage(obj)}else{}}